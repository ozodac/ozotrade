<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OZO Trade - Options Auto Trader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const OZOTrade = () => {
      const [balance, setBalance] = useState(100000);
      const [spxPrice, setSpxPrice] = useState(null);
      const [previousPrice, setPreviousPrice] = useState(null);
      const [position, setPosition] = useState(null);
      const [trades, setTrades] = useState([]);
      const [isTrading, setIsTrading] = useState(false);
      const [marketTrend, setMarketTrend] = useState('neutral');
      const [profitLoss, setProfitLoss] = useState(0);
      const [isLiveData, setIsLiveData] = useState(false);
      const [dataError, setDataError] = useState(null);
      const [priceHistory, setPriceHistory] = useState([]);
      
      const [showApiSettings, setShowApiSettings] = useState(false);
      const [apiKey, setApiKey] = useState('');
      const [apiKeyInput, setApiKeyInput] = useState('');
      const [useTradier, setUseTradier] = useState(false);
      const [optionsChain, setOptionsChain] = useState(null);
      
      // Strategy settings
      const [symbol, setSymbol] = useState('SPY');
      const [riskPercent, setRiskPercent] = useState(2);
      const [profitTarget, setProfitTarget] = useState(50);
      const [stopLoss, setStopLoss] = useState(50);
      const [useTrailingStop, setUseTrailingStop] = useState(false);
      const [trailingStopPercent, setTrailingStopPercent] = useState(20);
      
      // Backtesting
      const [isBacktesting, setIsBacktesting] = useState(false);
      const [backtestResults, setBacktestResults] = useState(null);
      
      // Performance tracking
      const [peakValue, setPeakValue] = useState(null);
      const [maxDrawdown, setMaxDrawdown] = useState(0);
      const [balanceHistory, setBalanceHistory] = useState([100000]);

      const fetchSPXPrice = async () => {
        try {
          let currentPrice = null;

          if (useTradier && apiKey) {
            const response = await fetch(
              `https://sandbox.tradier.com/v1/markets/quotes?symbols=${symbol}`,
              {
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Accept': 'application/json'
                }
              }
            );

            if (response.ok) {
              const data = await response.json();
              const quote = data.quotes?.quote;
              if (quote && quote.last) {
                currentPrice = quote.last;
                setIsLiveData(true);
                setDataError(null);
              } else {
                throw new Error('No quote data');
              }
            } else {
              throw new Error(`API Error ${response.status}`);
            }
          } else {
            const yahooSymbol = symbol === 'SPY' ? 'SPY' : '%5ESPX';
            const response = await fetch(
              `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=1m&range=1d`
            );
            
            if (!response.ok) throw new Error('Failed to fetch');
            
            const data = await response.json();
            const quote = data.chart.result[0];
            currentPrice = quote.meta.regularMarketPrice;
          }
          
          if (currentPrice) {
            setPreviousPrice(spxPrice);
            setSpxPrice(currentPrice);
            setPriceHistory(prev => [...prev.slice(-60), currentPrice]);
            setIsLiveData(true);
            setDataError(null);
            return currentPrice;
          }
        } catch (error) {
          console.error('Error fetching price:', error);
          setDataError('Using simulation mode');
          setIsLiveData(false);
          
          if (!spxPrice) setSpxPrice(symbol === 'SPY' ? 587 : 6170);
          return null;
        }
      };

      const fetchOptionsChain = async () => {
        if (!useTradier || !apiKey || !spxPrice) return null;

        try {
          const expResponse = await fetch(
            `https://sandbox.tradier.com/v1/markets/options/expirations?symbol=${symbol}`,
            {
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Accept': 'application/json'
              }
            }
          );

          if (!expResponse.ok) return null;

          const expData = await expResponse.json();
          const expirations = expData.expirations?.date;
          
          if (!expirations || expirations.length === 0) return null;

          const today = new Date().toISOString().split('T')[0];
          const todayExpiration = expirations.find(exp => exp === today) || expirations[0];

          const chainResponse = await fetch(
            `https://sandbox.tradier.com/v1/markets/options/chains?symbol=${symbol}&expiration=${todayExpiration}`,
            {
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Accept': 'application/json'
              }
            }
          );

          if (!chainResponse.ok) return null;

          const chainData = await chainResponse.json();
          setOptionsChain(chainData.options?.option || []);
          return chainData.options?.option || [];
        } catch (error) {
          console.error('Error fetching options chain:', error);
          return null;
        }
      };

      const findBestContract = (type) => {
        if (!optionsChain || optionsChain.length === 0) {
          const strikeOffset = symbol === 'SPY' ? 2 : 20;
          return {
            strike: type === 'call' ? Math.round(spxPrice + strikeOffset) : Math.round(spxPrice - strikeOffset),
            premium: Math.random() * 15 + 5,
            symbol: `${symbol}_${type.toUpperCase()}`
          };
        }

        const filterRange = symbol === 'SPY' ? 5 : 50;
        const filtered = optionsChain.filter(opt => 
          opt.option_type === type && 
          Math.abs(opt.strike - spxPrice) < filterRange
        );

        if (filtered.length === 0) return null;

        const best = filtered.reduce((prev, curr) => {
          const prevDist = Math.abs(prev.strike - spxPrice);
          const currDist = Math.abs(curr.strike - spxPrice);
          return currDist < prevDist ? curr : prev;
        });

        return {
          strike: best.strike,
          premium: best.ask || best.last || 10,
          symbol: best.symbol,
          bid: best.bid,
          ask: best.ask,
          volume: best.volume
        };
      };

      useEffect(() => {
        fetchSPXPrice();
        if (useTradier && apiKey) {
          fetchOptionsChain();
        }
      }, [apiKey, useTradier]);

      useEffect(() => {
        const interval = setInterval(() => {
          fetchSPXPrice();
          if (useTradier && apiKey && isTrading) {
            fetchOptionsChain();
          }
        }, 5000);

        return () => clearInterval(interval);
      }, [spxPrice, apiKey, useTradier, isTrading]);

      useEffect(() => {
        if (isLiveData || !isTrading) return;

        const interval = setInterval(() => {
          setSpxPrice(prev => {
            if (!prev) return symbol === 'SPY' ? 587 : 6170;
            const trendBias = marketTrend === 'bullish' ? 0.52 : marketTrend === 'bearish' ? 0.48 : 0.5;
            const volatility = symbol === 'SPY' ? 2 : 20;
            const change = (Math.random() - trendBias) * volatility;
            const minPrice = symbol === 'SPY' ? 500 : 5500;
            const maxPrice = symbol === 'SPY' ? 650 : 6500;
            const newPrice = Math.max(minPrice, Math.min(maxPrice, prev + change));
            setPriceHistory(p => [...p.slice(-60), newPrice]);
            return newPrice;
          });
        }, 2000);

        return () => clearInterval(interval);
      }, [isTrading, isLiveData, marketTrend]);

      const calculateIndicators = () => {
        if (priceHistory.length < 20) return { signal: null, trend: 'neutral', strength: 0 };

        const recent = priceHistory.slice(-20);
        const veryRecent = priceHistory.slice(-10);
        
        const sma20 = recent.reduce((a, b) => a + b, 0) / recent.length;
        const sma10 = veryRecent.reduce((a, b) => a + b, 0) / veryRecent.length;
        
        const momentum = (spxPrice - recent[0]) / recent[0];
        const shortMomentum = (spxPrice - veryRecent[0]) / veryRecent[0];
        
        const returns = [];
        for (let i = 1; i < recent.length; i++) {
          returns.push((recent[i] - recent[i-1]) / recent[i-1]);
        }
        const variance = returns.reduce((sum, r) => sum + r * r, 0) / returns.length;
        const volatility = Math.sqrt(variance);

        const trendStrength = Math.abs(momentum) * 100;

        let signal = null;
        let trend = 'neutral';

        // ORIGINAL CONDITIONS: 0.15%/0.08%/0.01%
        if (
          spxPrice > sma20 && 
          sma10 > sma20 && 
          momentum > 0.0015 && 
          shortMomentum > 0.0008 &&
          volatility > 0.0001
        ) {
          signal = 'call';
          trend = 'bullish';
        } 
        else if (
          spxPrice < sma20 && 
          sma10 < sma20 && 
          momentum < -0.0015 && 
          shortMomentum < -0.0008 &&
          volatility > 0.0001
        ) {
          signal = 'put';
          trend = 'bearish';
        }
        else {
          trend = 'neutral';
        }

        return { signal, trend, strength: trendStrength };
      };

      useEffect(() => {
        if (!isTrading || position || !spxPrice) return;

        const checkSignal = setInterval(() => {
          const { signal, trend, strength } = calculateIndicators();
          setMarketTrend(trend);
          
          if (signal && strength > 0.05) {
            executeTradeSignal(signal);
          }
        }, 10000);

        return () => clearInterval(checkSignal);
      }, [isTrading, position, spxPrice, priceHistory, optionsChain]);

      useEffect(() => {
        if (!position || !isTrading || !spxPrice) return;

        const monitor = setInterval(() => {
          checkExitCondition();
        }, 3000);

        return () => clearInterval(monitor);
      }, [position, spxPrice, isTrading]);

      const executeTradeSignal = (signal) => {
        if (balance < 1000 || !spxPrice) {
          if (balance < 1000) setIsTrading(false);
          return;
        }

        const contract = findBestContract(signal);
        if (!contract) return;

        const contracts = Math.max(1, Math.floor(balance * (riskPercent / 100) / 100));
        const cost = contracts * contract.premium * 100;

        if (cost > balance) return;

        const newPosition = {
          type: signal.toUpperCase(),
          strike: contract.strike,
          contracts,
          entryPrice: spxPrice,
          premium: contract.premium,
          cost,
          symbol: contract.symbol,
          entryTime: new Date(),
          targetProfit: cost * (profitTarget / 100),
          stopLoss: cost * (stopLoss / 100),
          trailingStopPrice: null,
          highestValue: cost,
          isRealContract: useTradier && apiKey && optionsChain
        };

        setPosition(newPosition);
        setBalance(prev => prev - cost);
      };

      const checkExitCondition = () => {
        if (!position || !spxPrice) return;

        const currentValue = calculatePositionValue(position, spxPrice);
        const pnl = currentValue - position.cost;
        
        if (useTrailingStop && currentValue > position.highestValue) {
          position.highestValue = currentValue;
          position.trailingStopPrice = currentValue * (1 - trailingStopPercent / 100);
        }
        
        const hitProfitTarget = pnl >= position.targetProfit;
        const hitStopLoss = pnl <= -position.stopLoss;
        const hitTrailingStop = useTrailingStop && position.trailingStopPrice && currentValue <= position.trailingStopPrice;
        const timeExpired = Date.now() - position.entryTime.getTime() > 300000;
        
        const shouldExit = hitProfitTarget || hitStopLoss || hitTrailingStop || timeExpired;

        if (shouldExit) {
          const exitReason = hitProfitTarget ? 'Profit Target' : 
                            hitTrailingStop ? 'Trailing Stop' :
                            hitStopLoss ? 'Stop Loss' : 'Time Limit';
          closePosition(currentValue, pnl, exitReason);
        }
      };

      const calculatePositionValue = (pos, currentPrice) => {
        if (!pos || !currentPrice) return 0;

        const priceMove = currentPrice - pos.entryPrice;
        const isWinning = (pos.type === 'CALL' && priceMove > 0) || 
                          (pos.type === 'PUT' && priceMove < 0);

        if (isWinning) {
          const profitMultiplier = Math.abs(priceMove) / 20;
          return pos.cost * (1 + profitMultiplier * 0.5);
        } else {
          const lossMultiplier = Math.abs(priceMove) / 20;
          return pos.cost * (1 - lossMultiplier * 0.3);
        }
      };

      const closePosition = (exitValue, pnl, exitReason = 'Manual') => {
        const newTrade = {
          ...position,
          exitPrice: spxPrice,
          exitValue,
          pnl,
          exitReason,
          exitTime: new Date(),
          outcome: pnl > 0 ? 'win' : 'loss'
        };

        setTrades(prev => [newTrade, ...prev].slice(0, 50));
        const newBalance = balance + exitValue;
        setBalance(newBalance);
        setProfitLoss(prev => prev + pnl);
        
        setBalanceHistory(prev => [...prev, newBalance].slice(-100));
        
        const currentPeak = Math.max(peakValue || 100000, newBalance);
        setPeakValue(currentPeak);
        const drawdown = ((currentPeak - newBalance) / currentPeak) * 100;
        setMaxDrawdown(Math.max(maxDrawdown, drawdown));
        
        setPosition(null);
      };

      const toggleTrading = () => {
        setIsTrading(!isTrading);
      };

      const resetSimulation = () => {
        setBalance(100000);
        setPosition(null);
        setTrades([]);
        setIsTrading(false);
        setProfitLoss(0);
        setPriceHistory([]);
        setBalanceHistory([100000]);
        setPeakValue(null);
        setMaxDrawdown(0);
        setBacktestResults(null);
        setIsBacktesting(false);
      };
      
      const runBacktest = () => {
        setIsBacktesting(true);
        setIsTrading(false);
        
        const generateHistoricalData = () => {
          const data = [];
          const startPrice = symbol === 'SPY' ? 587 : 6170;
          let price = startPrice;
          
          for (let day = 0; day < 30; day++) {
            const dailyTrend = (Math.random() - 0.48) * 0.02;
            
            for (let minute = 0; minute < 390; minute++) {
              const volatility = symbol === 'SPY' ? 0.5 : 5;
              const change = (Math.random() - 0.5 + dailyTrend) * volatility;
              price = Math.max(startPrice * 0.8, Math.min(startPrice * 1.2, price + change));
              data.push({
                timestamp: new Date(Date.now() - (30 - day) * 24 * 60 * 60 * 1000 + minute * 60 * 1000),
                price: price
              });
            }
          }
          return data;
        };
        
        const historicalData = generateHistoricalData();
        let testBalance = 100000;
        let testPosition = null;
        let testTrades = [];
        let testPriceHistory = [];
        let testPeak = 100000;
        let testMaxDD = 0;
        
        for (let i = 20; i < historicalData.length; i++) {
          const currentPrice = historicalData[i].price;
          testPriceHistory.push(currentPrice);
          
          if (testPosition) {
            const currentValue = calculatePositionValue(testPosition, currentPrice);
            const pnl = currentValue - testPosition.cost;
            
            if (useTrailingStop && currentValue > testPosition.highestValue) {
              testPosition.highestValue = currentValue;
              testPosition.trailingStopPrice = currentValue * (1 - trailingStopPercent / 100);
            }
            
            const hitProfitTarget = pnl >= testPosition.targetProfit;
            const hitStopLoss = pnl <= -testPosition.stopLoss;
            const hitTrailingStop = useTrailingStop && testPosition.trailingStopPrice && currentValue <= testPosition.trailingStopPrice;
            const timeExpired = i - testPosition.entryIndex > 100;
            
            if (hitProfitTarget || hitStopLoss || hitTrailingStop || timeExpired) {
              const exitReason = hitProfitTarget ? 'Profit Target' : 
                                hitTrailingStop ? 'Trailing Stop' :
                                hitStopLoss ? 'Stop Loss' : 'Time Limit';
              
              testTrades.push({
                ...testPosition,
                exitPrice: currentPrice,
                exitValue: currentValue,
                pnl,
                exitReason,
                outcome: pnl > 0 ? 'win' : 'loss'
              });
              
              testBalance += currentValue;
              testPeak = Math.max(testPeak, testBalance);
              const dd = ((testPeak - testBalance) / testPeak) * 100;
              testMaxDD = Math.max(testMaxDD, dd);
              
              testPosition = null;
            }
          } else {
            if (testBalance >= 1000 && testPriceHistory.length >= 20) {
              const recent = testPriceHistory.slice(-20);
              const veryRecent = testPriceHistory.slice(-10);
              const sma20 = recent.reduce((a, b) => a + b, 0) / recent.length;
              const sma10 = veryRecent.reduce((a, b) => a + b, 0) / veryRecent.length;
              const momentum = (currentPrice - recent[0]) / recent[0];
              const shortMomentum = (currentPrice - veryRecent[0]) / veryRecent[0];
              
              const returns = [];
              for (let j = 1; j < recent.length; j++) {
                returns.push((recent[j] - recent[j-1]) / recent[j-1]);
              }
              const variance = returns.reduce((sum, r) => sum + r * r, 0) / returns.length;
              const volatility = Math.sqrt(variance);
              
              let signal = null;
              
              // ORIGINAL CONDITIONS: 0.15%/0.08%/0.01%
              if (currentPrice > sma20 && sma10 > sma20 && momentum > 0.0015 && shortMomentum > 0.0008 && volatility > 0.0001) {
                signal = 'call';
              } else if (currentPrice < sma20 && sma10 < sma20 && momentum < -0.0015 && shortMomentum < -0.0008 && volatility > 0.0001) {
                signal = 'put';
              }
              
              if (signal) {
                const strikeOffset = symbol === 'SPY' ? 2 : 20;
                const strike = signal === 'call' ? Math.round(currentPrice + strikeOffset) : Math.round(currentPrice - strikeOffset);
                const premium = Math.random() * 15 + 5;
                const contracts = Math.max(1, Math.floor(testBalance * (riskPercent / 100) / 100));
                const cost = contracts * premium * 100;
                
                if (cost <= testBalance) {
                  testPosition = {
                    type: signal.toUpperCase(),
                    strike,
                    contracts,
                    entryPrice: currentPrice,
                    premium,
                    cost,
                    entryIndex: i,
                    targetProfit: cost * (profitTarget / 100),
                    stopLoss: cost * (stopLoss / 100),
                    trailingStopPrice: null,
                    highestValue: cost
                  };
                  
                  testBalance -= cost;
                }
              }
            }
          }
        }
        
        const winningTrades = testTrades.filter(t => t.outcome === 'win');
        const losingTrades = testTrades.filter(t => t.outcome === 'loss');
        const avgWin = winningTrades.length > 0 ? winningTrades.reduce((sum, t) => sum + t.pnl, 0) / winningTrades.length : 0;
        const avgLoss = losingTrades.length > 0 ? Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0) / losingTrades.length) : 0;
        const profitFactor = avgLoss > 0 ? avgWin / avgLoss : 0;
        
        const results = {
          totalTrades: testTrades.length,
          wins: winningTrades.length,
          losses: losingTrades.length,
          winRate: testTrades.length > 0 ? (winningTrades.length / testTrades.length * 100).toFixed(1) : 0,
          finalBalance: testBalance,
          totalPnL: testBalance - 100000,
          returnPercent: ((testBalance - 100000) / 100000 * 100).toFixed(2),
          maxDrawdown: testMaxDD.toFixed(2),
          avgWin: avgWin.toFixed(2),
          avgLoss: avgLoss.toFixed(2),
          profitFactor: profitFactor.toFixed(2),
          callTrades: testTrades.filter(t => t.type === 'CALL').length,
          putTrades: testTrades.filter(t => t.type === 'PUT').length,
          trades: testTrades
        };
        
        setBacktestResults(results);
        setIsBacktesting(false);
      };

      const saveApiKey = () => {
        setApiKey(apiKeyInput);
        setShowApiSettings(false);
        setUseTradier(true);
      };

      const winRate = trades.length > 0 
        ? (trades.filter(t => t.outcome === 'win').length / trades.length * 100).toFixed(1)
        : 0;

      const priceChange = previousPrice && spxPrice ? spxPrice - previousPrice : 0;
      const priceChangePercent = previousPrice ? (priceChange / previousPrice * 100) : 0;
      
      const callTrades = trades.filter(t => t.type === 'CALL').length;
      const putTrades = trades.filter(t => t.type === 'PUT').length;

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-4">
          <div className="max-w-7xl mx-auto">
            {showApiSettings && (
              <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl p-6 max-w-xl w-full border border-white/20">
                  <h2 className="text-2xl font-bold text-white mb-4">‚öôÔ∏è Settings</h2>
                  
                  <div className="mb-6">
                    <h3 className="text-lg font-semibold text-white mb-3">Symbol Selection</h3>
                    <div className="flex gap-3 mb-4">
                      <button
                        onClick={() => setSymbol('SPX')}
                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-all ${
                          symbol === 'SPX' 
                            ? 'bg-blue-500 text-white' 
                            : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                        }`}
                      >
                        SPX (Index)
                      </button>
                      <button
                        onClick={() => setSymbol('SPY')}
                        className={`flex-1 px-4 py-3 rounded-lg font-semibold transition-all ${
                          symbol === 'SPY' 
                            ? 'bg-blue-500 text-white' 
                            : 'bg-slate-700 text-gray-300 hover:bg-slate-600'
                        }`}
                      >
                        SPY (ETF)
                      </button>
                    </div>
                    <div className="bg-blue-500/10 border border-blue-400/30 rounded-lg p-3">
                      <p className="text-blue-200 text-xs">
                        <strong>SPX:</strong> Cash-settled index, 0DTE available, $10 multiplier<br/>
                        <strong>SPY:</strong> ETF with shares, more liquid, smaller contract size
                      </p>
                    </div>
                  </div>

                  <div className="mb-6">
                    <h3 className="text-lg font-semibold text-white mb-3">Tradier API</h3>
                    <p className="text-gray-300 text-sm mb-3">
                      Get your Sandbox API key from <a href="https://sandbox.tradier.com/user/profile" target="_blank" className="text-blue-400 underline">sandbox.tradier.com</a>
                    </p>
                    <input
                      type="password"
                      value={apiKeyInput}
                      onChange={(e) => setApiKeyInput(e.target.value)}
                      placeholder="Enter Tradier API Key (optional)"
                      className="w-full px-4 py-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-400 focus:outline-none mb-4"
                    />
                  </div>

                  <div className="mb-6">
                    <h3 className="text-lg font-semibold text-white mb-3">Strategy Settings</h3>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="text-gray-300 text-sm block mb-2">Risk Per Trade (%)</label>
                        <input
                          type="number"
                          value={riskPercent}
                          onChange={(e) => setRiskPercent(Number(e.target.value))}
                          min="1"
                          max="10"
                          className="w-full px-4 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-400 focus:outline-none"
                        />
                      </div>
                      
                      <div>
                        <label className="text-gray-300 text-sm block mb-2">Profit Target (%)</label>
                        <input
                          type="number"
                          value={profitTarget}
                          onChange={(e) => setProfitTarget(Number(e.target.value))}
                          min="10"
                          max="200"
                          className="w-full px-4 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-400 focus:outline-none"
                        />
                      </div>
                      
                      <div>
                        <label className="text-gray-300 text-sm block mb-2">Stop Loss (%)</label>
                        <input
                          type="number"
                          value={stopLoss}
                          onChange={(e) => setStopLoss(Number(e.target.value))}
                          min="10"
                          max="100"
                          className="w-full px-4 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-400 focus:outline-none"
                        />
                      </div>
                      
                      <div>
                        <div className="flex items-center justify-between mb-2">
                          <label className="text-gray-300 text-sm">Trailing Stop</label>
                          <button
                            onClick={() => setUseTrailingStop(!useTrailingStop)}
                            className={`px-3 py-1 rounded text-xs font-semibold transition-all ${
                              useTrailingStop 
                                ? 'bg-green-500 text-white' 
                                : 'bg-slate-600 text-gray-300'
                            }`}
                          >
                            {useTrailingStop ? 'ON' : 'OFF'}
                          </button>
                        </div>
                        {useTrailingStop && (
                          <input
                            type="number"
                            value={trailingStopPercent}
                            onChange={(e) => setTrailingStopPercent(Number(e.target.value))}
                            min="5"
                            max="50"
                            placeholder="Trailing %"
                            className="w-full px-4 py-2 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-400 focus:outline-none"
                          />
                        )}
                        <p className="text-xs text-gray-400 mt-1">
                          Locks in profits as price moves in your favor
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={saveApiKey}
                      className="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold"
                    >
                      Save Settings
                    </button>
                    <button
                      onClick={() => setShowApiSettings(false)}
                      className="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-semibold"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 mb-6 border border-white/20">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-3xl font-bold text-white mb-2">
                    üî• OZO Trade - Options Auto Trader
                  </h1>
                  <p className="text-blue-200 text-sm">
                    {useTradier && apiKey ? 'Tradier API Connected' : 'Simulation Mode'} ‚Ä¢ Trading {symbol} CALLS & PUTS
                  </p>
                  <p className="text-green-300 text-xs mt-1">
                    ‚ö° Optimized Entry: 0.15% momentum, 0.08% short-term, 0.01% volatility | Expect 15-30 trades/month
                  </p>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setShowApiSettings(true)}
                    className="px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 rounded-lg"
                  >
                    ‚öôÔ∏è Settings
                  </button>
                  <div className="px-4 py-2 bg-white/5 rounded-lg border border-white/10">
                    <span className={`font-semibold text-sm ${isLiveData ? 'text-green-400' : 'text-orange-400'}`}>
                      {isLiveData ? 'üü¢ LIVE' : 'üü† SIM'}
                    </span>
                  </div>
                </div>
              </div>
              {dataError && (
                <div className="mt-3 text-orange-300 text-sm">‚ö†Ô∏è {dataError}</div>
              )}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div className="bg-gradient-to-br from-green-500/20 to-green-600/20 backdrop-blur-md rounded-lg p-6 border border-green-400/30">
                <div className="text-green-200 text-sm font-medium mb-2">Balance</div>
                <div className="text-2xl font-bold text-white">
                  ${balance.toLocaleString(undefined, {minimumFractionDigits: 2})}
                </div>
                <div className="text-xs text-green-200 mt-1">
                  Peak: ${(peakValue || 100000).toLocaleString()}
                </div>
              </div>

              <div className={`bg-gradient-to-br ${profitLoss >= 0 ? 'from-blue-500/20 to-blue-600/20 border-blue-400/30' : 'from-red-500/20 to-red-600/20 border-red-400/30'} backdrop-blur-md rounded-lg p-6 border`}>
                <div className="text-white/80 text-sm font-medium mb-2">Total P&L</div>
                <div className={`text-2xl font-bold ${profitLoss >= 0 ? 'text-blue-300' : 'text-red-300'}`}>
                  {profitLoss >= 0 ? '+' : ''}${Math.abs(profitLoss).toLocaleString(undefined, {minimumFractionDigits: 2})}
                </div>
                <div className="text-xs text-white/60 mt-1">
                  {((profitLoss / 100000) * 100).toFixed(2)}% ‚Ä¢ Max DD: {maxDrawdown.toFixed(2)}%
                </div>
              </div>

              <div className="bg-gradient-to-br from-purple-500/20 to-purple-600/20 backdrop-blur-md rounded-lg p-6 border border-purple-400/30">
                <div className="text-purple-200 text-sm font-medium mb-2">{symbol} Price</div>
                <div className="text-2xl font-bold text-white">
                  {spxPrice ? `$${spxPrice.toFixed(2)}` : 'Loading...'}
                </div>
                {priceChange !== 0 && (
                  <div className={`text-xs font-semibold mt-1 ${priceChange > 0 ? 'text-green-400' : 'text-red-400'}`}>
                    {priceChange > 0 ? '+' : ''}{priceChange.toFixed(2)} ({priceChangePercent > 0 ? '+' : ''}{priceChangePercent.toFixed(2)}%)
                  </div>
                )}
              </div>

              <div className="bg-gradient-to-br from-amber-500/20 to-amber-600/20 backdrop-blur-md rounded-lg p-6 border border-amber-400/30">
                <div className="text-amber-200 text-sm font-medium mb-2">Win Rate</div>
                <div className="text-2xl font-bold text-white">{winRate}%</div>
                <div className="text-xs text-amber-200 mt-1">
                  {trades.length} trades ({callTrades} calls, {putTrades} puts)
                </div>
              </div>
            </div>

            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 mb-6 border border-white/20">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h2 className="text-xl font-bold text-white mb-1">Trading Status</h2>
                  <p className="text-sm text-blue-200">
                    Market Trend: <span className={`font-semibold ${
                      marketTrend === 'bullish' ? 'text-green-400' : 
                      marketTrend === 'bearish' ? 'text-red-400' : 'text-gray-400'
                    }`}>{marketTrend.toUpperCase()}</span>
                    <span className="ml-3 text-gray-400">
                      Risk: {riskPercent}% | Target: +{profitTarget}% | Stop: -{stopLoss}%
                      {useTrailingStop && ` | Trail: ${trailingStopPercent}%`}
                    </span>
                  </p>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={toggleTrading}
                    disabled={!spxPrice || isBacktesting}
                    className={`px-6 py-3 rounded-lg font-semibold transition-all ${
                      isTrading 
                        ? 'bg-red-500 hover:bg-red-600 text-white' 
                        : 'bg-green-500 hover:bg-green-600 text-white disabled:opacity-50'
                    }`}
                  >
                    {isTrading ? '‚è∏ Stop Trading' : '‚ñ∂ Start Trading'}
                  </button>
                  <button
                    onClick={runBacktest}
                    disabled={isTrading || isBacktesting}
                    className="px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold disabled:opacity-50 transition-all"
                  >
                    {isBacktesting ? '‚è≥ Running...' : 'üî¨ Backtest'}
                  </button>
                  <button
                    onClick={resetSimulation}
                    className="px-6 py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-semibold"
                  >
                    üîÑ Reset
                  </button>
                </div>
              </div>

              {position && (
                <div className="bg-white/5 rounded-lg p-4 border border-white/10">
                  <h3 className="text-white font-semibold mb-3 flex items-center gap-2">
                    <span className={position.type === 'CALL' ? 'text-green-400' : 'text-red-400'}>
                      {position.type === 'CALL' ? 'üìà' : 'üìâ'}
                    </span>
                    Active Position: {position.type}
                    {position.isRealContract && <span className="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded">Real Contract</span>}
                    {useTrailingStop && position.trailingStopPrice && (
                      <span className="text-xs bg-blue-500/20 text-blue-300 px-2 py-1 rounded">
                        Trail: ${position.trailingStopPrice.toFixed(2)}
                      </span>
                    )}
                  </h3>
                  <div className="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm">
                    <div>
                      <span className="text-gray-400">Strike:</span>
                      <div className="text-white font-semibold">${position.strike}</div>
                    </div>
                    <div>
                      <span className="text-gray-400">Contracts:</span>
                      <div className="text-white font-semibold">{position.contracts}</div>
                    </div>
                    <div>
                      <span className="text-gray-400">Entry:</span>
                      <div className="text-white font-semibold">${position.entryPrice.toFixed(2)}</div>
                    </div>
                    <div>
                      <span className="text-gray-400">Current:</span>
                      <div className="text-white font-semibold">${spxPrice.toFixed(2)}</div>
                    </div>
                    <div>
                      <span className="text-gray-400">P&L:</span>
                      <div className={`font-semibold ${
                        calculatePositionValue(position, spxPrice) - position.cost > 0 
                          ? 'text-green-400' : 'text-red-400'
                      }`}>
                        ${(calculatePositionValue(position, spxPrice) - position.cost).toFixed(2)}
                      </div>
                    </div>
                    <div>
                      <span className="text-gray-400">Peak Value:</span>
                      <div className="text-white font-semibold">${position.highestValue.toFixed(2)}</div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {backtestResults && (
              <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 mb-6 border border-white/20">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold text-white">Backtest Results - 30 Days</h2>
                  <button
                    onClick={() => setBacktestResults(null)}
                    className="text-gray-400 hover:text-white"
                  >
                    ‚úï Close
                  </button>
                </div>
                
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="bg-white/5 rounded-lg p-4">
                    <div className="text-gray-400 text-sm mb-1">Final Balance</div>
                    <div className={`text-2xl font-bold ${backtestResults.totalPnL >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                      ${backtestResults.finalBalance.toLocaleString()}
                    </div>
                    <div className="text-xs text-gray-400 mt-1">
                      {backtestResults.totalPnL >= 0 ? '+' : ''}${backtestResults.totalPnL.toLocaleString()} ({backtestResults.returnPercent}%)
                    </div>
                  </div>
                  
                  <div className="bg-white/5 rounded-lg p-4">
                    <div className="text-gray-400 text-sm mb-1">Win Rate</div>
                    <div className="text-2xl font-bold text-white">{backtestResults.winRate}%</div>
                    <div className="text-xs text-gray-400 mt-1">
                      {backtestResults.wins}W / {backtestResults.losses}L
                    </div>
                  </div>
                  
                  <div className="bg-white/5 rounded-lg p-4">
                    <div className="text-gray-400 text-sm mb-1">Profit Factor</div>
                    <div className={`text-2xl font-bold ${backtestResults.profitFactor >= 1.5 ? 'text-green-400' : backtestResults.profitFactor >= 1 ? 'text-yellow-400' : 'text-red-400'}`}>
                      {backtestResults.profitFactor}
                    </div>
                    <div className="text-xs text-gray-400 mt-1">
                      Avg Win: ${backtestResults.avgWin} / Avg Loss: ${backtestResults.avgLoss}
                    </div>
                  </div>
                  
                  <div className="bg-white/5 rounded-lg p-4">
                    <div className="text-gray-400 text-sm mb-1">Max Drawdown</div>
                    <div className="text-2xl font-bold text-red-400">{backtestResults.maxDrawdown}%</div>
                    <div className="text-xs text-gray-400 mt-1">
                      {backtestResults.totalTrades} total trades
                    </div>
                  </div>
                </div>
                
                <div className="bg-blue-500/10 border border-blue-400/30 rounded-lg p-4">
                  <h3 className="text-white font-semibold mb-2">Performance Summary</h3>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div>
                      <span className="text-gray-400">Total Trades:</span>
                      <span className="text-white ml-2 font-semibold">{backtestResults.totalTrades}</span>
                    </div>
                    <div>
                      <span className="text-gray-400">CALL Trades:</span>
                      <span className="text-green-400 ml-2 font-semibold">{backtestResults.callTrades}</span>
                    </div>
                    <div>
                      <span className="text-gray-400">PUT Trades:</span>
                      <span className="text-red-400 ml-2 font-semibold">{backtestResults.putTrades}</span>
                    </div>
                    <div>
                      <span className="text-gray-400">Strategy Status:</span>
                      <span className="text-white ml-2 font-semibold">
                        {backtestResults.profitFactor >= 1.5 ? '‚úÖ Excellent' : backtestResults.profitFactor >= 1 ? '‚ö†Ô∏è Profitable' : '‚ùå Needs Work'}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
              <h2 className="text-xl font-bold text-white mb-4">Recent Trades</h2>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {trades.length === 0 ? (
                  <p className="text-gray-400 text-center py-8">No trades yet. Start trading to see history.</p>
                ) : (
                  trades.map((trade, idx) => (
                    <div key={idx} className="bg-white/5 rounded-lg p-4 border border-white/10">
                      <div className="flex items-center justify-between">
                        <div>
                          <div className="text-white font-semibold flex items-center gap-2">
                            <span className={trade.type === 'CALL' ? 'text-green-400' : 'text-red-400'}>
                              {trade.type === 'CALL' ? 'üìà' : 'üìâ'}
                            </span>
                            {trade.type} ${trade.strike}
                            {trade.isRealContract && <span className="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded">Real</span>}
                            <span className="text-xs bg-slate-700 text-gray-300 px-2 py-0.5 rounded">{trade.exitReason}</span>
                          </div>
                          <div className="text-xs text-gray-400">
                            {trade.contracts} contracts ‚Ä¢ ${trade.entryPrice.toFixed(2)} ‚Üí ${trade.exitPrice.toFixed(2)}
                          </div>
                        </div>
                        <div className="text-right">
                          <div className={`text-lg font-bold ${trade.pnl > 0 ? 'text-green-400' : 'text-red-400'}`}>
                            {trade.pnl > 0 ? '+' : ''}${Math.abs(trade.pnl).toFixed(2)}
                          </div>
                          <div className="text-xs text-gray-400">
                            {((trade.pnl / trade.cost) * 100).toFixed(1)}%
                          </div>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>

            <div className="mt-6 bg-yellow-500/20 backdrop-blur-md rounded-lg p-4 border border-yellow-400/30">
              <p className="text-yellow-200 text-sm">
                ‚ö†Ô∏è <strong>Disclaimer:</strong> Paper trading with simulated/real market data. Options trading involves substantial risk of loss. Past performance does not guarantee future results. Always consult professionals before live trading.
              </p>
            </div>

            <div className="mt-4 text-center text-gray-400 text-sm">
              <p>Powered by OZO Trade ‚Ä¢ Built with React & Tailwind CSS</p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<OZOTrade />, document.getElementById('root'));
  </script>
</body>
</html>